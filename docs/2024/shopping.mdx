---
title: shopping
slug: /2024/shopping
date: 2024-09-30
unlisted: true
---



```yaml
      qq:
        - topic: 商品模块
          qs:
            - q: 怎么设计 sku 系统的表
              x: |
                主表

                - 商品表
                - sku 表
                - sku 属性表
                - 商品表对 sku 表一对多，sku 表对 sku 属性表一对多

                拓展性

                - 分类表
                - 商品表
                - sku 表（库存表）
                - 属性名表
                - 属性值表
                - 商品和属性的关联表
                - 商品和属性的筛选表（用 sql 全文检索实现筛选）
                - 商品搜索表

            - q: 有哪些场景需要库存回滚
              x: |
                - （用户未支付）用户下单后后悔了
                - （用户支付后取消）用户下单&支付后后悔了
                - （风控取消）风控识别到异常行为，强制取消订单
                - （耦合系统故障）比如提交订单时提单系统 T1 同时会调用积分扣减系统 X1、库存扣减系统 X2、优惠券系统 X3，假如 X1,X2 成功后，调用 X3 失败，需要回滚用户积分与商家库存。

            - q: 库存扣减有哪些方案？库存扣多了，怎么办？怎么保证不多扣？
              x: |
                - 用“设置库存”替代“扣减库存”，以保证幂等性
                - 使用 CAS 乐观锁，在“设置库存”时加上原始库存的比对，避免数据不一致


        - topic: 购物车cart
          qs:
            - q: cart table schema?
            - q: 未登录用户添加商品到购物车，登录后，怎么合并购物车？
              x: |
                - 未登录下加入购物车很简单，具体操作如下，服务端下发 key，客户端把 key 存本地，添加购物车时，服务端创建一个结构为`shopcart:notlogin:{key}`的 hash，值为`goodsId:{附加数据}`，再次添加时直接找到对应 key，往里面添加新数据就可以了
                - 登录后合并购物车，具体操作如下，登录后异步任务，把上面的`shopcart:notlogin:{key}`的数据插入到数据库，和登录状态下的购物车数据合并，再 rewrite 到`shopcart:login:{userId}`里

        - topic: 订单模块
          qs:
            - q: x
              u: https://zhuanlan.zhihu.com/p/374504083
              x: 订单模块是交易系统的核心，向上拓展出充值模块，向下拓展出支付模块

            - q: 订单
              u: https://www.bilibili.com/video/BV1tN4y1d7mk/
            # https://www.bilibili.com/video/BV1hp4y1J7X5/
            # https://www.bilibili.com/video/BV13u4y1271j/

            - q: 订单模块的表设计：订单模块都有哪些表？
              x: |
                - 主表
                - 购物车表
                - 订单表
                - 订单商品详情表
                - 附属表
                - 订单发票表
                - 订单物流表
                - 订单退货表
                - 收货地址表
                - 用于电话营销的订单模块的拓展设计
                - 订单业务审核流程表
                - 订单提成表
                - 订单调度表

                ---

                - 支付状态：未支付，已支付
                - 物流状态：未发货，已发货，已签收
                - 订单状态：等待付款，等待发货，确认收货，交易完成，交易关闭
                - 售后状态：申请售后，退款完成

            - q: 订单模块中订单状态和支付状态的关系？
            - q: trx_id 和 trx_code 分别是什么？有什么区别？一个 trx_id 对应多个 trx_code 么？
              x: |
                - transaction_id 是我们项目里的交易号
                - transaction_code 是支付成功后，这笔交易的 code
            - q: 是否每次支付请求都生成一个新的 transaction_code（不重复）来解决重复支付问题，如果真的是重复提交支付请求并重复支付了，那么解决退款问题呢，具体退哪一笔？
            - q: 重复支付后具体退哪一笔？如果用户支付了两笔，你肯定会收到两个异步通知，那么最后收到的异步通知视为重复支付，对其进行退款。这样如果用户重复多次申请支付，是不是导致transaction_code 膨胀？
              x: 关于膨胀的问题，可以对 code 设置一个生成次数，比如：2^6。因为一般超过这么多次还在发起请求要么是恶作剧，要么你支付服务出了故障。


            - q: 生成订单号，有哪些关键需求？订单号的生成规则？由什么组成？怎么生成订单号？有哪些方案？
              u: https://gist.github.com/XBPk3T/4a9de86688fb2d596c4db27dfa7f4d8a
              x: |
                *既需要控制订单号长度，又要保证高并发下订单号唯一*

                - `订单号长度`：不要超过 22 位
                - `高并发`：保证百万级 qps 不重复
                - `订单号唯一`

                ---

                - `时间戳 14 位 + 用户 id8 位 (千万级用户)`为了保证安全性，可以*对用户 id 用 FNV 哈希算法取值*，并填充或者对该值进行位运算来*保证统一长度*
                - 一定要使用完整用户 id，因为*取用户 id 前 n 位的碰撞概率很高*
                - 该方案天然支持分库分表下根据订单号查询、根据用户 ID 查询、根据商户号查询这三类核心查询，因为用户 id 是固定的，`hash(last6(orderId))%16`取模后的值也是相同的 (`因子分表法`)，某个用户的所有订单都会分在同一个表，很容易查询
                - `snowflake`如果不需要时间串的话，可以直接使用 snowflake，不需要校验机制
                - `时间戳 14 位 (精确到秒)+随机数串 8 位`，*但是使用随机数串，一定要有校验机制，而不是直接生成随机串*。所以，要做一个`随机串池`，加锁去取，来保证随机串唯一

            - q: 订单号、交易号、流水号之间的关系？
              x: |
                - 订单号是指客户下订单时系统生成的唯一编号
                - 交易号是指客户完成支付后系统生成的唯一编号
                - 流水号是指客户完成支付后第三方支付平台生成的唯一编号

                - 电商业务，订单号和流水号，通常是一对一的

                - 如果一个订单需要多次支付，或者对不同业务方支付，或者存在退款的情况，就是一对多
                - 如果多笔订单，需要汇总结算支付，就是多对一

            - q: 订单拆分 (子订单)
              x: |
                - 订单拆分的原因？拆单分为“物理拆单”和“逻辑拆单”两种。实际上，用户结算实际上是“合并付款”，用户付款结束后，我们把订单按照店铺拆单。这样退款的时候，实际上退的是某个店铺的子订单
                - 订单拆分的原则是什么？不改变原始订单数据
                - 怎么拆分订单？
                  - 如果是 B2C 如京东，*根据 sku拆单，生成多条能关联到父订单的子订单*
                  - 如果是 B2B2C 如淘宝，通常拆分两次，先根据商家拆单，再根据上加下sku 拆单
                - 是否需要“订单合并”？
                - 订单转移和订单拆分分别是什么？有什么关系？
        - topic: 退货退款
          qs:
            - q: 用户下单后退款，但是积分已经被使用掉了，怎么办？
              x: "*用户只有在确认收货后，积分才能被使用。用户下单后，积分冻结状态，只展示，但是无法使用*
          。这样就不存在下单后退款，积分却已经被使用的情况了"
            - q: 用户退款成功后，获得的积分是否要退还？如果目前该用户的总积分少于退还积分，怎么办？
            - q: 订单涉及到多商品 + 优惠券 + 积分，怎么退款？通常有三种方案
              x: |
                - `不支持单品退货，只能退整单`。金额退还，赠送积分扣掉，优惠券扣掉
                - `退单品，退还该商品按比例分摊后的实际支付金额`
                - `退单品，直接退还该商品的售价`
                  ，重新计算优惠券分摊，从用户账户除了扣掉赠送积分，还要扣掉分摊后对应优惠券金额对应的积分数
        - topic: 营销活动
          qs:
            - q: 电商应用中有哪些常见的营销活动形式？
              x: (折扣, 满减, 优惠券, (满返, 抽奖, 换购, 买一送一))
            - q: 多种营销活动（比如满减、购物券、折扣、红包、金币、跨店满减）叠加计算扣减，如何实现？
              u: https://v2ex.com/t/1043252
              x: 规则引擎 QLExpress


        - topic: 优惠券
          qs:

            - q: 优惠券发放
              x: |
                - 活动统一发放
                - 用户操作触发
                - 活动页面发放
                - 订单满额发放
                - 邀请好友发放
                - 新用户注册发放

        - topic:
          qs:
              x: |
                出口时会在截关日期前准备好资料先报关，截关后货物放行装船离港，船舶办妥结关手续后带货离港。所以，结关日期一般晚于截关日，更是晚于报关日。而这一些系列动作完毕后才能算完整的通关。因此，时间先后顺序即报关-截关-结关-通关。

                单证放行是指报关单放行；
                已放行是指货物放行；
                已结关是指海关已为该票货物办理结关手手续。

                结关在放行之后，结关后海关会向电子口岸发送电子数据，若只是处于已放行的单子，说明尚未结关，一般货物出口后5个工作日内海关会为货物办理结关手续。

```